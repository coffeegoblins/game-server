/**
 * @license RequireJS text 2.0.9 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/text for details
 */

define("engine/game/viewport",[],function(){"use strict";function e(e){this.scale=1,this.minScale=.25,this.maxScale=4,this.renderer=e,this.controllerStack=new LinkedList,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.canvas.tabIndex=0,document.body.firstChild?document.body.insertBefore(this.canvas,document.body.firstChild):document.body.appendChild(this.canvas),this.rect=new Rectangle(0,0,this.canvas.clientWidth,this.canvas.clientHeight),this.onResize(),window.addEventListener("resize",this.onResize.bind(this)),window.viewport=this}var t={border:0,centerTarget:!1,leadTarget:!1,isPercentageBased:!1,leadScale:1};return e.prototype.addController=function(e){var i=Utility.merge({},t,e);return this.controllerStack.addFirst(i),i},e.prototype.fromScreen=function(e,t){return this.renderer.fromScreen(this,e,t)},e.prototype.move=function(e,t){this.setPosition(this.rect.left+e,this.rect.top+t)},e.prototype.onResize=function(){this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.rect.width=this.canvas.width/this.scale,this.rect.height=this.canvas.height/this.scale,this.rect.setPosition(Math.floor(this.rect.center.x-this.rect.width/2),Math.floor(this.rect.center.y-this.rect.height/2))},e.prototype.removeController=function(e){this.controllerStack.remove(e)},e.prototype.setBounds=function(e){e?(this.bounds=e,this.setPosition(this.rect.left,this.rect.top)):this.bounds=null},e.prototype.setPosition=function(e,t){this.bounds&&(this.bounds.width<this.rect.width?e=0:e<this.bounds.left?e=this.bounds.left:e>this.bounds.right-this.rect.width&&(e=this.bounds.right-this.rect.width),this.bounds.height<this.rect.height?t=0:t<this.bounds.top?t=this.bounds.top:t>this.bounds.bottom-this.rect.height&&(t=this.bounds.bottom-this.rect.height)),this.rect.setPosition(Math.floor(e),Math.floor(t))},e.prototype.setScale=function(e,t){if(e=Utility.clamp(e,this.minScale,this.maxScale),this.scale!==e){var i=this.renderer.fromScreen(this,t.x,t.y);this.scale=e,this.rect.width=this.canvas.width/e,this.rect.height=this.canvas.height/e;var r=this.renderer.toScreen(this,i.x,i.y),n=r.x-t.x,s=r.y-t.y;this.rect.setPosition(Math.floor(this.rect.left+n),Math.floor(this.rect.top+s))}},e.prototype.toScreen=function(e,t){return this.renderer.toScreen(this,e,t)},e.prototype.update=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.updateController()},e.prototype.updateController=function(){var e=this.controllerStack.first;if(e&&e.target){var t=e.border,i=e.border;e.isPercentageBased&&(t*=this.rect.width,i*=this.rect.height);var r=e.target.rect.center.x,n=e.target.rect.center.y;e.leadTarget&&(r+=e.target.velocity.x*e.leadScale,n+=e.target.velocity.y*e.leadScale);var s,o;e.centerTarget?(s=r-this.rect.width/2,o=n-this.rect.height/2):(s=this.rect.left,o=this.rect.top);var a=s+this.rect.width-t,h=o+this.rect.height-i;e.target.rect.left<s+t?s=e.target.rect.left-t:e.target.rect.right>a&&(s=s+e.target.rect.right-a),e.target.rect.top<o+i?o=e.target.rect.top-i:e.target.rect.bottom>h&&(o=o+e.target.rect.bottom-h),(s!==this.rect.x||o!==this.rect.y)&&this.setPosition(s,o)}},e}),define("engine/core/scheduler",[],function(){"use strict";function e(){}function t(o){if(e.isRunning){var a=.001*(o-s);s=o,a>.05&&(a=.05);for(var h=r.first;h;)h.timeRemaining-=a,h.timeRemaining<0&&(h.method.call(h.context,h,a),h.timeRemaining+=h.interval,h.timeRemaining<0&&(h.timeRemaining=0)),h=h.next;for(h=n.first;h;)h.timeRemaining-=a,h.timeRemaining<0&&n.remove(h),h=h.next;i=window.requestAnimationFrame(t)}}var i,r,n,s=0;return e.isRunning=!1,e.priority={update:1e3,animation:500,render:100},e.limitExecution=function(e,t,i){for(var r=n.first;r;){if(r.method===e&&r.context===t)return;r=r.next}return n.addLast({method:e,context:t,timeRemaining:i}),e.apply(t)},e.start=function(){r||(r=new LinkedList),n||(n=new LinkedList),e.isRunning=!0,i=window.requestAnimationFrame(t)},e.stop=function(){e.isRunning=!1,window.cancelAnimationFrame(i)},e.schedule=function(t){null==t.interval&&(t.interval=0),null==t.priority&&(t.priority=e.priority.update),t.timeRemaining=t.interval,r.insertSorted(t,"priority")},e.unschedule=function(e){r.remove(e)},e.unscheduleById=function(e){r.removeBy("id",e)},e}),define("engine/core/linkedList",[],function(){"use strict";function e(){this.first=null}return e.prototype.addFirst=function(e){e.next=this.first,this.first=e},e.prototype.addLast=function(e){if(e.next=null,this.first){for(var t=this.first;t.next;)t=t.next;t.next=e}else this.first=e},e.prototype.insertSorted=function(e,t){if(this.first)if(this.first[t]<e[t])e.next=this.first,this.first=e;else{for(var i=this.first;i.next&&i.next[t]>e[t];)i=i.next;e.next=i.next,i.next=e}else this.first=e},e.prototype.remove=function(e){if(this.first)if(this.first===e)this.first=this.first.next;else for(var t=this.first;t&&t.next;){if(t.next===e){t.next=t.next.next;break}t=t.next}},e.prototype.removeBy=function(e,t){if(this.first)if(this.first[e]===t)this.first=this.first.next;else for(var i=this.first;i&&i.next;){if(i.next[e]===t){i.next=i.next.next;break}i=i.next}},e.prototype.removeFirst=function(){this.first&&(this.first=this.first.next)},e.prototype.removeLast=function(){if(this.first&&this.first.next){for(var e=this.first;e.next.next;)e=e.next;e.next=null}else this.first=null},e}),define("engine/core/rectangle",[],function(){"use strict";function e(e,t,i,r){this.width=i,this.height=r,this.center=new Vector2,this.setPosition(e,t)}return e.prototype.clone=function(){return new e(this.left,this.top,this.width,this.height)},e.prototype.getPosition=function(){return new Vector2(this.left,this.top)},e.prototype.getSimpleRect=function(){return{x:this.left,y:this.top,width:this.width,height:this.height}},e.prototype.getSize=function(){return new Vector2(this.width,this.height)},e.prototype.setCenter=function(e,t){this.center.x=e,this.center.y=t;var i=this.width/2,r=this.height/2;this.left=e-i,this.top=t-r,this.right=e-i,this.bottom=t-r},e.prototype.setPosition=function(e,t){this.left=e,this.top=t,this.right=e+this.width,this.bottom=t+this.height,this.center.x=e+this.width/2,this.center.y=t+this.height/2},e.prototype.setSize=function(e,t){this.width=e,this.height=t,this.right=this.left+this.width,this.bottom=this.top+this.height,this.center.x=this.left+this.width/2,this.center.y=this.top+this.height/2},e.prototype.setSizeFromCenter=function(e,t){this.width=e,this.height=t;var i=this.width/2,r=this.height/2;this.left=this.center.x-i,this.top=this.center.y-r,this.right=this.center.x+i,this.bottom=this.center.y+r},e.prototype.scale=function(e,t){t!==!1?this.setSize(this.width*e,this.height*e):(this.width*=e,this.height*=e,this.setPosition(this.left*e,this.top*e))},e.prototype.translate=function(e,t){this.setPosition(this.left+e,this.top+t)},e.fromPoints=function(t,i,r,n){var s,o,a,h;return r>t?(s=t,a=r-t):(s=r,a=t-r),n>i?(o=i,h=n-i):(o=n,h=i-n),new e(s,o,a,h)},e.fromSimpleRect=function(t){return new e(t.x,t.y,t.width,t.height)},e}),define("engine/core/utility",[],function(){"use strict";for(var e,t=["matches","webkitMatchesSelector","mozMatchesSelector","msMatchesSelector","oMatchesSelector"],i=document.createElement("div"),r=0;r<t.length;r++)if(i[t[r]]){e=t[r];break}return{appendElements:function(e,t){if(Array.isArray(t))for(var i=0;i<t.length;i++)e.appendChild(t[i]);else e.appendChild(t)},clamp:function(e,t,i){return t>=e?t:e>=i?i:e},filter:function(e,t){for(var i={},r=0;r<t.length;r++){var n=t[r];i[n]=e[n]}return i},findByProperty:function(e,t,i){for(var r=0;r<e.length;r++)if(e[r][t]===i)return e[r]},findByProperties:function(e,t){for(var i=0;i<e.length;i++){var r=!0;for(var n in t)if(e[i][n]!==t[n]){r=!1;break}if(r)return e[i]}},findParent:function(e,t){for(;e&&!Utility.matches(e,t);)e=e.parentNode;return e},getElementFromTemplate:function(e,t){var i=document.createElement("div");i.innerHTML=e;for(var r=[],n=0;n<i.childNodes.length;n++){var s=i.childNodes[n];8===s.nodeType||3===s.nodeType&&!/S/.test(s.nodeValue)||(r.push(s),t&&t.appendChild(s))}return r.length>1?r:r[0]},getSign:function(e){return e?0>e?-1:1:0},inherit:function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype.parent=t.prototype},isObjectEmpty:function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},matches:function(t,i){return t[e]?t[e](i):void 0},merge:function(){for(var e=arguments[0],t=1;t<arguments.length;t++){var i=arguments[t];if(i)for(var r in i)e[r]=i[r]}return e},remove:function(e,t){var i=e.indexOf(t);return i>=0?(e.splice(i,1),!0):void 0},removeByProperty:function(e,t,i){for(var r=0;r<e.length;r++)if(e[r][t]===i)return e.splice(r,1)[0]},removeByProperties:function(e,t){for(var i=0;i<e.length;i++){var r=!0;for(var n in t)if(e[i][n]!==t[n]){r=!1;break}if(r)return e.splice(i,1)[0]}}}}),define("engine/core/vector2",[],function(){"use strict";function e(e,t){this.x=e||0,this.y=t||0}return e.prototype.angle=function(e){return null==e?Math.atan2(this.y,this.x):(this.x=Math.cos(e),this.y=Math.sin(e),void 0)},e.prototype.clone=function(){return new e(this.x,this.y)},e.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},e.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y},e.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y);return this.x/=e,this.y/=e,e},e.prototype.rotate=function(e){var t=Math.sin(e),i=Math.cos(e);this.x=this.x*i-this.y*t,this.y=this.x*t+this.y*i,this.normalize()},e.add=function(t,i){return new e(t.x+i.x,t.y+i.y)},e.distance=function(e,t){var i=e.x-t.x,r=e.y-t.y;return Math.sqrt(i*i+r*r)},e.distanceSquared=function(e,t){var i=e.x-t.x,r=e.y-t.y;return i*i+r*r},e.divide=function(t,i){return new e(t.x/i,t.y/i)},e.dot=function(e,t){return e.x*t.x+e.y*t.y},e.leftPerpendicular=function(t){return new e(t.y,-t.x)},e.multiply=function(t,i){return new e(t.x*i,t.y*i)},e.normalize=function(t){var i=Math.sqrt(t.x*t.x+t.y*t.y);return new e(t.x/i,t.y/i)},e.reverse=function(t){return new e(-t.x,-t.y)},e.rightPerpendicular=function(t){return new e(-t.y,t.x)},e.subtract=function(t,i){return new e(t.x-i.x,t.y-i.y)},e}),define("engine/game/game",["./viewport","../core/scheduler","../core/linkedList","../core/rectangle","../core/utility","../core/vector2"],function(e,t,i,r,n,s){"use strict";return window.LinkedList=i,window.Rectangle=r,window.Utility=n,window.Vector2=s,{onReady:function(e,i){var r=setInterval(function(){"complete"===document.readyState&&(clearInterval(r),this.renderer=i,t.start(),e())}.bind(this),20)},setScene:function(t){this.scene&&(this.scene.close(),this.scene.viewport=null),this.scene=t,this.scene.onLoaded(new e(this.renderer))}}}),define("engine/rendering/render2dIsometric",[],function(){"use strict";return{drawGrid:function(e,t,i){for(var r,n,s=e.context,o=e.rect,a=i*e.scale/2,h=a/2,l=0;l<=t.width;l++)r=this.tileToScreen(l,0,a,h),n=this.tileToScreen(l,t.height,a,h),s.beginPath(),s.moveTo(r.x+a-o.left,r.y-o.top),s.lineTo(n.x+a-o.left,n.y-o.top),s.stroke();for(var c=0;c<=t.height;c++)r=this.tileToScreen(0,c,a,h),n=this.tileToScreen(t.width,c,a,h),s.beginPath(),s.moveTo(r.x+a-o.left,r.y-o.top),s.lineTo(n.x+a-o.left,n.y-o.top),s.stroke()},drawRectangle:function(e,t){var i=e.context;i.beginPath();var r=this.toScreen(e,t.left,t.top);i.moveTo(r.x,r.y),r=this.toScreen(e,t.right,t.top),i.lineTo(r.x,r.y),r=this.toScreen(e,t.right,t.bottom),i.lineTo(r.x,r.y),r=this.toScreen(e,t.left,t.bottom),i.lineTo(r.x,r.y),i.closePath()},drawTiles:function(e,t,i){var r,n;t.xOffset||t.yOffset?(r=e.rect.clone(),n=this.toISO(-t.xOffset,-t.yOffset),r.translate(n.x*e.scale,n.y*e.scale)):r=e.rect;for(var s=t.tileSize*e.scale,o=s/2,a=o/2,h=e.context,l=r.left,c=r.top,p=0;p<t.width;p++)for(var d=0;d<t.height;d++){var u=t.getTile(p,d);if(u){var f=i.getTileBounds(u-1);f&&(n=this.tileToScreen(p,d,o,a),h.drawImage(i.image.data,f.x,f.y,f.width,f.height,n.x-l,n.y-c,s,o))}}},screenToTile:function(e,t,i,r){return{x:Math.floor((e/i+t/r)/2),y:Math.floor((t/r-e/i)/2)}},tileToScreen:function(e,t,i,r){return{x:(e-t)*i-i,y:(e+t)*r}},fromISO:function(e,t){return{x:e+2*t,y:2*t-e}},toISO:function(e,t){return{x:(e-t)/2,y:(e+t)/4}},fromScreen:function(e,t,i){return t+=e.rect.left,i+=e.rect.top,new Vector2((t+2*i)/e.scale,(2*i-t)/e.scale)},toScreen:function(e,t,i){return new Vector2((t-i)/2*e.scale-e.rect.left,(t+i)/4*e.scale-e.rect.top)}}}),define("engine/rendering/render2d",[],function(){"use strict";return{drawCircle:function(e,t,i){e.context.beginPath(),e.context.arc(t.x-e.rect.left,t.y-e.rect.top,i,0,2*Math.PI,!1)},drawGrid:function(e,t,i){for(var r=e.context,n=e.rect,s=Math.max(0,Math.floor(n.left/i)),o=Math.max(0,Math.floor(n.top/i)),a=Math.min(t.width,Math.ceil(n.right/i)),h=Math.min(t.height,Math.ceil(n.bottom/i)),l=Math.floor((o*i-n.top)*e.scale),c=Math.floor((h*i-n.top)*e.scale),p=s;a>=p;p++){var d=Math.floor((p*i-n.left)*e.scale);r.beginPath(),r.moveTo(d,l),r.lineTo(d,c),r.stroke()}for(var u=Math.floor((s*i-n.left)*e.scale),f=Math.floor((a*i-n.left)*e.scale),y=o;h>=y;y++){var m=Math.floor((y*i-n.top)*e.scale);r.beginPath(),r.moveTo(u,m),r.lineTo(f,m),r.stroke()}},drawRectangle:function(e,t){var i=Math.floor((t.left-e.rect.left)*e.scale),r=Math.floor((t.top-e.rect.top)*e.scale),n=Math.floor(t.width*e.scale),s=Math.floor(t.height*e.scale);e.context.beginPath(),e.context.rect(i,r,n,s)},drawTiles:function(e,t,i){var r;t.xOffset||t.yOffset?(r=e.rect.clone(),r.translate(-t.xOffset,-t.yOffset)):r=e.rect;for(var n=t.tileSize,s=Math.max(0,Math.floor(r.left/n)),o=Math.max(0,Math.floor(r.top/n)),a=Math.min(t.width-1,Math.ceil(r.right/n)),h=Math.min(t.height-1,Math.ceil(r.bottom/n)),l=n*e.scale,c=s;a>=c;c++)for(var p=o;h>=p;p++){var d=t.getTile(c,p);if(d){var u=i.getTileBounds(d-1);if(u){var f=(c*n-r.left)*e.scale,y=(p*n-r.top)*e.scale;e.context.drawImage(i.image.data,u.x,u.y,u.width,u.height,f,y,l,l)}}}},fromScreen:function(e,t,i){return new Vector2(e.rect.left+t/e.scale,e.rect.top+i/e.scale)},toScreen:function(e,t,i){return new Vector2((t-e.rect.left)*e.scale,(i-e.rect.top)*e.scale)}}}),define("engine/data/fileHandler",[],function(){"use strict";var e=window.URL||window.webkitURL;return{loadImage:function(e,t){if(e&&e.type.match("image.*")){var i=new FileReader;return i.onload=function(i){t(e.name,i.target.result)},i.readAsDataURL(e),!0}},loadJSON:function(e,t){if(e){var i=e.name.lastIndexOf("."),r=e.name.substr(i+1);if("json"!==r.toLowerCase())return;var n=new FileReader;return n.onload=function(i){t(e.name,JSON.parse(i.target.result))},n.readAsText(e),!0}},requestJSON:function(e,t){var i=new XMLHttpRequest;i.overrideMimeType("application/json"),i.open("GET",e+".json"),i.onreadystatechange=function(){4===i.readyState&&200===i.status&&t(JSON.parse(i.responseText))},i.send()},saveJSON:function(t,i){Array.isArray(i)||(i=[i]);var r;try{r=e.createObjectURL(new Blob(i,{type:"application/json"}));var n=document.createElement("a");n.href=r,n.target="_target",n.download=t,n.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0}))}catch(s){console.log(s)}finally{r&&e.revokeObjectURL(r)}}}}),define("engine/media/imageCache",[],function(){"use strict";function e(e,i){var r={isLoaded:!1,data:new Image,callback:i};return r.data.onload=t.bind(r),r.data.src=e,r}function t(){this.width=this.data.width,this.height=this.data.height,this.isLoaded=!0,this.callback&&(this.callback(this),this.callback=void 0),this.data.onload=void 0}var i={};return{clear:function(){i={}},createImage:function(t,i){return e(t,i)},getAll:function(){var e=[];for(var t in i)e.push(i[t]);return e},getImage:function(e){return i[e]},isLoading:function(){for(var e in i)if(!i[e].isLoaded)return!0;return!1},loadImage:function(t,r,n){var s=i[t];return s||(s=e(r,n),s.id=t,i[t]=s),s},unloadImage:function(e){delete i[e]}}}),define("engine/core/events",[],function(){"use strict";function e(){var e=arguments[0];this.events||(this.events={}),this.events[e]||(this.events[e]=[]);var t,i;arguments.length>2?(t=arguments[1],i=arguments[2]):i=arguments[1],this.events[e].push({context:t,method:i})}function t(){if(this.events){var e=arguments[0];arguments.length>=3?Utility.removeByProperties(this.events[e],{context:arguments[1],method:arguments[2]}):2===arguments.length?Utility.removeByProperty(this.events[e],"method",arguments[1]):this.events[e]=void 0}}function i(){if(this.events){var e=this.events[arguments[0]];if(e&&e.length){Array.prototype.shift.call(arguments);for(var t=0;t<e.length;t++){var i=e[t];i.method.apply(i.context,arguments)}}}}return{register:function(r){return r.on=e,r.off=t,r.trigger=i,r}}}),define("engine/core/inputHandler",["./events"],function(e){"use strict";function t(e,t){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)>10}function i(e){var i=null!=e.identifier?e.identifier:"mouse",r=I[i];if(r){var n=r.events[0],s=r.events[r.events.length-1];if(n.targetId===s.targetId){if(r.isDragging){var o=r.events[r.events.length-2],a=o.x-s.x,h=o.y-s.y;M.trigger("drag",e,a,h)}else t(n,s)&&(r.isDragging=!0,M.trigger("dragBegin",e));return!0}}}function r(e){var t=null!=e.identifier?e.identifier:"mouse",i=I[t];if(i){var r=i.events;if(!(r.length>1&&r[0].targetId!==r[r.length-1].targetId)){if(i.isDragging){var n=r.pop(),s=r.pop(),o=n.x-s.x,a=n.y-s.y;M.trigger("dragEnd",e,o,a)}else M.trigger("click",e);delete I[i.id]}}}function n(e,t,i){var r=I[t.identifier],n=I[i.identifier],s=r.events[0],o=n.events[0];if(!(Math.abs(s.timestamp-o.timestamp)>250)){var a=r.events[r.events.length-1],h=n.events[n.events.length-1],l=r.events[r.events.length-2],c=n.events[n.events.length-2],p=Math.abs(l.x-c.x)+Math.abs(l.y-c.y),d=Math.abs(a.x-h.x)+Math.abs(a.y-h.y),u=(a.x+h.x)/2,f=(a.y+h.y)/2,y=document.body.offsetWidth+document.body.offsetHeight,m=5*(d-p)/y;return M.trigger("pinch",e,u,f,m),!0}}function s(e){var t=null!=e.identifier?e.identifier:"mouse",i=I[t];return i||(i={id:t,events:[]},I[t]=i),i.events.push({targetId:e.target.id,timestamp:e.timeStamp,x:e.pageX,y:e.pageY}),i}function o(e){if(L){var t=k[e.keyCode]?M.Keys.Control:e.keyCode;j[t]=!0,g(R,t)||M.trigger("keydown",e)}}function a(e){if(L){var t=k[e.keyCode]?M.Keys.Control:e.keyCode;j[t]=!1,w(R,t)||M.trigger("keyup",e)}}function h(e){L&&m(e.target.id,e.button)&&(s(e),M.trigger("mousedown",e))}function l(e){L&&(I.mouse&&(s(e),i(e)),M.trigger("mousemove",e))}function c(e){L&&(r(e),b(e.target.id,e.button),M.trigger("mouseup",e))}function p(e){if(L){var t=Utility.clamp(e.wheelDelta||-e.detail,-1,1);M.trigger("mousewheel",e,.15*t)}}function d(e){if(L&&e.changedTouches)for(var t=0;t<e.changedTouches.length;t++){var i=e.changedTouches[t];s(i),m(i.target.id,M.Keys.MouseLeft)}e.preventDefault()}function u(e){if(L&&e.touches){for(var t=0;t<e.touches.length;t++)s(e.touches[t]);var r;if(1===e.touches.length?r=i(e.touches[0]):2===e.touches.length&&(r=n(e,e.touches[0],e.touches[1])),!r)for(t=0;t<e.touches.length;t++){var o=e.touches[t],a=I[o.identifier].events[0];b(a.targetId,M.Keys.MouseLeft),m(o.target.id,M.Keys.MouseLeft)}}e.preventDefault()}function f(e){if(L&&e.changedTouches)for(var t=0;t<e.changedTouches.length;t++){var i=e.changedTouches[t];r(i),b(i.target.id,M.Keys.MouseLeft)}e.preventDefault()}function y(e){if(L&&e.changedTouches)for(var t=0;t<e.changedTouches.length;t++){var i=e.changedTouches[t];delete I[i.identifier],b(i.target.id,M.Keys.MouseLeft)}}function m(e,t){return g(N,e)?void 0:(j[t]=!0,g(R,t),!0)}function g(e,t){var i=e[t];if(i){for(var r=0;r<i.length;r++)v(i[r]);return!0}return!1}function v(e){var t=C[e];t&&(E[t.name]=!0,T[t.name]||(T[t.name]=!0,M.trigger(t.name)))}function b(e,t){return w(N,e)?void 0:(j[t]=!1,w(R,t),!0)}function w(e,t){var i=e[t];if(i){for(var r=0;r<i.length;r++)S(i[r]);return!0}return!1}function S(e){var t=C[e];t&&(E[t.name]=!1,T[t.name]=!1)}function x(e,t,i,r){i&&(e[t]?e[t].push(i):e[t]=[i],r&&(r[i]?r[i].push(e.name):r[i]=[e.name]))}function P(e,t,i,r){if(null!=i){e[t]&&Utility.remove(e[t],i);var n=r[i];n&&(Utility.remove(n,e.name),n.length||(r[i]=void 0))}}function M(){}var L=!0,k={17:!0,91:!0,93:!0,224:!0},C={},E={},T={},j={},I={},R={},N={};M.isTouchEnabled="ontouchstart"in window||"onmsgesturechange"in window,M.Keys={MouseLeft:0,MouseMiddle:1,MouseRight:2,Backspace:8,Enter:13,Shift:16,Control:17,Alt:18,Escape:27,Spacebar:32,Left:37,Up:38,Right:39,Down:40,Delete:46,Number0:48,Number1:49,Number2:50,Number3:51,Number4:52,Number5:53,Number6:54,Number7:55,Number8:56,Number9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NumPad0:96,NumPad1:97,NumPad2:98,NumPad3:99,NumPad4:100,NumPad5:101,NumPad6:102,NumPad7:103,NumPad8:104,NumPad9:105,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,Tilde:192},M.clearInput=function(){j={},E={},I={},T={}},M.disableInput=function(){L=!1},M.enableInput=function(){L=!0},M.isActive=function(e){return E[e]},M.isKeyDown=function(e){return j[e]},M.registerAction=function(e,t,i){var r=e.name,n=C[r];n||(n={name:r},C[r]=n),x(n,"inputKeys",e.key,R),x(n,"elementIds",e.elementId,N),i&&M.on(r,t,i)},M.unregisterAction=function(e){var t=C[e.name];t&&(P(t,"inputKeys",e.key,R),P(t,"elementIds",e.elementId,N),t.inputKeys&&t.inputKeys.length||t.elementIds&&t.elementIds.length||(C[e.name]=void 0))};var O=function(e){e.preventDefault()},U=function(e){var t=e.target.tagName;t&&"canvas"===t.toLowerCase()&&e.preventDefault()};return window.addEventListener("contextmenu",O,!1),window.addEventListener("MSHoldVisual",O,!1),window.addEventListener("ondragstart",O,!1),window.addEventListener("ondrop",O,!1),window.addEventListener("selectstart",U,!1),window.addEventListener("keydown",o,!1),window.addEventListener("keyup",a,!1),window.addEventListener("mousedown",h,!1),window.addEventListener("mousemove",l,!1),window.addEventListener("mouseup",c,!1),window.addEventListener("mousewheel",p,!1),window.addEventListener("DOMMouseScroll",p,!1),window.addEventListener("blur",M.clearInput),M.isTouchEnabled&&(window.addEventListener("touchstart",d,!1),window.addEventListener("touchmove",u,!1),window.addEventListener("touchend",f,!1),window.addEventListener("touchcancel",y,!1),document.body.msTouchAction="none",document.body.className+=" touch"),e.register(M),M}),define("editor/controls/popup",["engine/core/events"],function(e){"use strict";function t(e,t){this.items=e,this.displayName=t}var i;return t.prototype.close=function(){document.body.removeChild(this.element),i=null,this.trigger("close")},t.prototype.onClick=function(e){var t=Utility.findParent(e.target,".popup-item"),i=t.querySelector("span");if(i){var r=i.innerHTML;r&&(this.trigger("itemClick",r,this.items[r]),this.close())}},t.prototype.show=function(e,t){i&&i.close(),this.element=document.createElement("div"),this.element.className="popup popup-menu",this.itemMap=[];for(var r in this.items)if(this.items.hasOwnProperty(r)){var n=document.createElement("div");n.className="popup-item";var s=document.createElement("span");s.appendChild(document.createTextNode(r)),n.appendChild(s),this.element.appendChild(n),this.itemMap.push({itemName:r,itemObject:this.items[r],element:n})}document.body.appendChild(this.element);var o=this.element.offsetWidth,a=this.element.offsetHeight,h=document.body.clientWidth,l=document.body.clientHeight;return this.left=e-o/2,this.top=t+16,this.element.style.top=Utility.clamp(this.top,8,l-a-8)+"px",this.element.style.left=Utility.clamp(this.left,8,h-o-8)+"px",this.element.style.maxWidth=h+"px",this.element.style.maxHeight=l+"px",this.element.addEventListener("click",this.onClick.bind(this),!1),i=this,this},window.addEventListener("mousedown",function(e){i&&!Utility.findParent(e.target,".popup")&&i.close()},!1),e.register(t.prototype),t}),define("editor/controls/propertiesSection",["engine/core/events"],function(e){"use strict";function t(e,t){var i=e.valueProperty,r=parseFloat(t);return r!=t&&(r=i.value),("width"===i.key||"height"===i.key)&&(r=Math.round(r),1>r&&(r=i.value)),r}function i(){this.element=document.createElement("div"),this.element.className="properties",this.element.addEventListener("change",this.onElementChanged.bind(this),!1),this.properties=[],this.config=Utility.merge({},r)}var r={exclude:{typeName:!0},position:{isRequired:!0,isNumeric:!0},rect:{isRequired:!0,map:["left","top","width","height"],validate:t}};return i.prototype.addValues=function(e){for(var t=this.getPropertiesFromObject(e),i=document.createDocumentFragment(),r=0;r<t.length;r++){var n=document.createElement("div");n.className="property-element";var s=document.createElement("input");s.className="property-key",s.type="text";var o=t[r];s.value=o.key,o.element=s;var a=this.config[o.key];a&&(s.disabled=a.isRequired);var h=document.createElement("div");h.className="property-value";for(var l=o.values.length,c=Math.floor((140-(l-1))/l)+"px",p=0;l>p;p++){var d=document.createElement("input");d.className="property-value-item",d.type="text",d.style.width=c;var u=o.values[p];d.value=u.value,u.element=d,h.appendChild(d)}n.appendChild(s),n.appendChild(h),i.appendChild(n)}this.element.appendChild(i),this.properties.push.apply(this.properties,t)},i.prototype.constrainValue=function(e,t){var i=this.config[e.property.key];if(i)i.validate?t=i.validate(e,t):i.isNumeric&&(t=parseFloat(t),null!=t&&isFinite(t)||(t=e.valueProperty.value),i.minValue&&(t=Math.max(t,i.minValue)),i.maxValue&&(t=Math.min(t,i.maxValue)));else{var r=parseFloat(t);r==t&&(t=r)}return t},i.prototype.getPropertyForElement=function(e){for(var t=0;t<this.properties.length;t++){var i=this.properties[t];if(i.element===e)return{property:i};var r=Utility.findByProperty(i.values,"element",e);if(r)return{property:i,valueProperty:r}}},i.prototype.getPropertiesFromObject=function(e){var t=[];for(var i in e)if(e.hasOwnProperty(i)&&(!this.config.exclude||!this.config.exclude[i])){var r={key:i,values:[]};t.push(r);var n=e[i];if("object"==typeof n){var s;if(this.config[i]&&(s=this.config[i].map),s)for(var o=0;o<s.length;o++)r.values.push({key:s[o],value:n[s[o]]});else for(var a in n)n.hasOwnProperty(a)&&r.values.push({key:a,value:n[a]})}else r.values.push({value:n})}return t},i.prototype.onElementChanged=function(e){var t=this.getPropertyForElement(e.target);if(t){var i,r;if(t.valueProperty?(i=this.constrainValue(t,e.target.value),r=t.valueProperty.value,t.valueProperty.value=i):(i=e.target.value.replace(" ",""),r=t.property.key,i?t.property.key=i:(Utility.remove(this.properties,t.property),this.element.removeChild(Utility.findParent(e.target,".property-element")))),r!==i){if(this.trigger("propertyChange",t.property,t.valueProperty),e.target.value=i,t.valueProperty)t.valueProperty.key?this.object[t.property.key][t.valueProperty.key]=i:this.object[t.property.key]=i;else{var n=this.object[r];delete this.object[r],i&&(this.object[i]=n)}this.object.onPropertyChanged&&this.object.onPropertyChanged(t.property,t.valueProperty)}e.stopPropagation()}},i.prototype.addNewProperty=function(){this.object.key="value",this.addValues({key:"value"})},i.prototype.clear=function(){for(this.properties.length=0;this.element.firstChild;)this.element.removeChild(this.element.firstChild)},i.prototype.setConfig=function(e){this.config=Utility.merge({},r,e)},i.prototype.setObject=function(e){this.clear(),this.object=e,this.addValues(e)},i.prototype.update=function(){for(var e=0;e<this.properties.length;e++)for(var t=this.properties[e],i=this.object[t.key],r=0;r<t.values.length;r++){var n=t.values[r];n.element.value=n.key?i[n.key]:i}},e.register(i.prototype),i}),define("engine/spatial/tileMap",[],function(){"use strict";function e(e,t,i,r){this.xOffset=0,this.yOffset=0,this.width=e,this.height=t,this.tileSize=i,r||(r=Uint8Array),this.tiles=new r(new ArrayBuffer(e*t))}return e.prototype.getTile=function(e,t){return this.tiles[e+t*this.width]},e.prototype.getTileAtIndex=function(e){return this.tiles[e]},e.prototype.getTileAtPosition=function(e,t){return e=Math.floor(e/this.tileSize),t=Math.floor(t/this.tileSize),this.tiles[e+t*this.width]},e.prototype.isInBounds=function(e,t){return e>=0&&t>=0&&e<this.width&&t<this.height},e.prototype.setTile=function(e,t,i){this.tiles[e+t*this.width]=i},e.prototype.setTileAtIndex=function(e,t){this.tiles[e]=t},e.prototype.setTileAtPosition=function(e,t,i){e=Math.floor(e/this.tileSize),t=Math.floor(t/this.tileSize),this.tiles[e+t*this.width]=i},e}),define("engine/data/webStorage",["../core/events"],function(e){"use strict";function t(){}var i;return t.setSaveInterval=function(e){i&&clearInterval(i),i=setInterval(function(){t.trigger("save")},1e3*e)},t.getData=function(e){if(window.localStorage){var t=window.localStorage.getItem(e);if(t)return JSON.parse(t)}},t.deleteData=function(){if(window.localStorage)for(var e=0;e<arguments.length;e++)window.localStorage.removeItem(arguments[e])},t.hasData=function(){if(!window.localStorage)return!1;for(var e=0;e<arguments.length;e++)if(!window.localStorage.getItem(arguments[e]))return!1;return!0},t.setData=function(e,t){if(window.localStorage)try{window.localStorage.setItem(e,JSON.stringify(t))}catch(i){}},window.localStorage&&window.addEventListener("beforeunload",function(){t.trigger("save")},!1),e.register(t),t}),define("text",["module"],function(e){"use strict";var t,i,r,n,s,o=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],a=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,h=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,l="undefined"!=typeof location&&location.href,c=l&&location.protocol&&location.protocol.replace(/\:/,""),p=l&&location.hostname,d=l&&(location.port||void 0),u={},f=e.config&&e.config()||{};return t={version:"2.0.9",strip:function(e){if(e){e=e.replace(a,"");var t=e.match(h);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:f.createXhr||function(){var e,t,i;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(t=0;3>t;t+=1){i=o[t];try{e=new ActiveXObject(i)}catch(r){}if(e){o=[i];break}}return e},parseName:function(e){var t,i,r,n=!1,s=e.indexOf("."),o=0===e.indexOf("./")||0===e.indexOf("../");return-1!==s&&(!o||s>1)?(t=e.substring(0,s),i=e.substring(s+1,e.length)):t=e,r=i||t,s=r.indexOf("!"),-1!==s&&(n="strip"===r.substring(s+1),r=r.substring(0,s),i?i=r:t=r),{moduleName:t,ext:i,strip:n}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,i,r,n){var s,o,a,h=t.xdRegExp.exec(e);return h?(s=h[2],o=h[3],o=o.split(":"),a=o[1],o=o[0],!(s&&s!==i||o&&o.toLowerCase()!==r.toLowerCase()||(a||o)&&a!==n)):!0},finishLoad:function(e,i,r,n){r=i?t.strip(r):r,f.isBuild&&(u[e]=r),n(r)},load:function(e,i,r,n){if(n.isBuild&&!n.inlineText)return r(),void 0;f.isBuild=n.isBuild;var s=t.parseName(e),o=s.moduleName+(s.ext?"."+s.ext:""),a=i.toUrl(o),h=f.useXhr||t.useXhr;!l||h(a,c,p,d)?t.get(a,function(i){t.finishLoad(e,s.strip,i,r)},function(e){r.error&&r.error(e)}):i([o],function(e){t.finishLoad(s.moduleName+"."+s.ext,s.strip,e,r)})},write:function(e,i,r){if(u.hasOwnProperty(i)){var n=t.jsEscape(u[i]);r.asModule(e+"!"+i,"define(function () { return '"+n+"';});\n")}},writeFile:function(e,i,r,n,s){var o=t.parseName(i),a=o.ext?"."+o.ext:"",h=o.moduleName+a,l=r.toUrl(o.moduleName+a)+".js";t.load(h,r,function(){var i=function(e){return n(l,e)};i.asModule=function(e,t){return n.asModule(e,l,t)},t.write(e,h,i,s)},s)}},"node"===f.env||!f.env&&"undefined"!=typeof process&&process.versions&&process.versions.node&&!process.versions["node-webkit"]?(i=require.nodeRequire("fs"),t.get=function(e,t,r){try{var n=i.readFileSync(e,"utf8");0===n.indexOf("ï»¿")&&(n=n.substring(1)),t(n)}catch(s){r(s)}}):"xhr"===f.env||!f.env&&t.createXhr()?t.get=function(e,i,r,n){var s,o=t.createXhr();if(o.open("GET",e,!0),n)for(s in n)n.hasOwnProperty(s)&&o.setRequestHeader(s.toLowerCase(),n[s]);f.onXhr&&f.onXhr(o,e),o.onreadystatechange=function(){var t,n;
4===o.readyState&&(t=o.status,t>399&&600>t?(n=new Error(e+" HTTP status: "+t),n.xhr=o,r(n)):i(o.responseText),f.onXhrComplete&&f.onXhrComplete(o,e))},o.send(null)}:"rhino"===f.env||!f.env&&"undefined"!=typeof Packages&&"undefined"!=typeof java?t.get=function(e,t){var i,r,n="utf-8",s=new java.io.File(e),o=java.lang.System.getProperty("line.separator"),a=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(s),n)),h="";try{for(i=new java.lang.StringBuffer,r=a.readLine(),r&&r.length()&&65279===r.charAt(0)&&(r=r.substring(1)),null!==r&&i.append(r);null!==(r=a.readLine());)i.append(o),i.append(r);h=String(i.toString())}finally{a.close()}t(h)}:("xpconnect"===f.env||!f.env&&"undefined"!=typeof Components&&Components.classes&&Components.interfaces)&&(r=Components.classes,n=Components.interfaces,Components.utils["import"]("resource://gre/modules/FileUtils.jsm"),s="@mozilla.org/windows-registry-key;1"in r,t.get=function(e,t){var i,o,a,h={};s&&(e=e.replace(/\//g,"\\")),a=new FileUtils.File(e);try{i=r["@mozilla.org/network/file-input-stream;1"].createInstance(n.nsIFileInputStream),i.init(a,1,0,!1),o=r["@mozilla.org/intl/converter-input-stream;1"].createInstance(n.nsIConverterInputStream),o.init(i,"utf-8",i.available(),n.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),o.readString(i.available(),h),o.close(),i.close(),t(h.value)}catch(l){throw new Error((a&&a.path||"")+": "+l)}}),t}),define("text!editor/templates/mainPanel.html",[],function(){return'<div class="main-panel">\r\n    <div data-name="level-panel">\r\n        <div class="header">\r\n            <label>Level</label>\r\n            <div class="header-button-panel">\r\n                <div class="icon add-icon" title="Add property"></div>\r\n            </div>\r\n        </div>\r\n        <div class="contents">\r\n            <input data-name="saveFileName" type="text" placeholder="File name"/>\r\n            <button data-name="new">New</button>\r\n            <button data-name="save">Save</button>\r\n            <input type="file" data-name="load"/>\r\n        </div>\r\n    </div>\r\n    <div data-name="grid-panel">\r\n        <div class="header">\r\n            <label>Grid</label>\r\n            <div class="header-button-panel">\r\n                <div class="icon visibility-icon" title="Toggle grid visibility"></div>\r\n            </div>\r\n        </div>\r\n        <div class="contents"></div>\r\n    </div>\r\n    <div data-name="layer-panel">\r\n        <div class="header">\r\n            <label>Layers</label>\r\n            <div class="header-button-panel">\r\n                <div class="icon up-icon" title="Move layer up"></div>\r\n                <div class="icon down-icon" title="Move layer down"></div>\r\n                <div class="icon add-icon" title="Add layer"></div>\r\n            </div>\r\n        </div>\r\n        <div class="layer-item-panel"></div>\r\n    </div>\r\n    <div class="properties-panel"></div>\r\n</div>'}),define("text!editor/templates/layer.html",[],function(){return'<div class="layer">\r\n    <div class="icon visibility-icon visible" title="Toggle layer visibility"></div>\r\n    <div class="layer-title-container">\r\n        <input type="text"/>\r\n    </div>\r\n    <div class="icon remove-icon" title="Remove layer"></div>\r\n</div>'}),define("editor/core/mainPanel",["Editor","text!../templates/mainPanel.html","text!../templates/layer.html"],function(e,t,i){"use strict";function r(){var i={isVisible:!1,rect:new Rectangle(0,0,64,64),tileSize:64};e.getGridSettings=function(){return i},this.grid=i,this.layers=[],document.body.insertAdjacentHTML("beforeend",t),this.element=document.body.querySelector(".main-panel"),this.layerItemPanel=this.element.querySelector(".layer-item-panel"),this.propertiesPanel=this.element.querySelector(".properties-panel"),this.properties={},this.propertiesSection=new e.PropertiesSection,this.propertiesSection.setObject(this.properties),this.initialize()}function n(e,t){e.isVisible=!e.isVisible,e.isVisible?t.classList.add("visible"):t.classList.remove("visible")}return r.prototype.initialize=function(){this.element.addEventListener("click",this.onClick.bind(this));var t=this.element.querySelector('[data-name="level-panel"');t.querySelector('[data-name="new"]').addEventListener("click",this.clear.bind(this),!1),t.querySelector('[data-name="load"]').addEventListener("change",this.onLoad.bind(this),!1),t.querySelector('[data-name="save"]').addEventListener("click",this.onSave.bind(this),!1),t.querySelector(".add-icon").addEventListener("click",this.propertiesSection.addNewProperty.bind(this.propertiesSection),!1),t.querySelector(".contents").appendChild(this.propertiesSection.element);var i=this.element.querySelector('[data-name="layer-panel"');i.querySelector(".add-icon").addEventListener("click",this.onAddLayer.bind(this),!1),i.querySelector(".up-icon").addEventListener("click",this.onMoveLayerUp.bind(this),!1),i.querySelector(".down-icon").addEventListener("click",this.onMoveLayerDown.bind(this),!1);var r=this.element.querySelector('[data-name="grid-panel"');r.querySelector(".visibility-icon").addEventListener("click",this.onToggleGridVisibility.bind(this),!1);var n=new e.PropertiesSection;n.setConfig({exclude:{isVisible:!0},tileSize:{isRequired:!0,minValue:1}}),n.setObject(this.grid),r.querySelector(".contents").appendChild(n.element)},r.prototype.onAddLayer=function(t){var i=e.Plugins.layerTypes;i&&!Utility.isObjectEmpty(i)&&(this.popup=new e.Popup(i).show(t.pageX,t.pageY),this.popup.on("close",this,function(){this.popup=null}.bind(this)),this.popup.on("itemClick",this,function(e,t){this.createLayerFromType(e,t)}.bind(this)))},r.prototype.onMoveLayerUp=function(){if(this.layers.length>1){var e=this.layers.indexOf(this.selectedLayer);e>0&&(this.layers.splice(e-1,0,this.layers.splice(e,1)[0]),this.layerItemPanel.insertBefore(this.selectedLayer.element,this.selectedLayer.element.previousSibling))}},r.prototype.onMoveLayerDown=function(){if(this.layers.length>1){var e=this.layers.indexOf(this.selectedLayer);e<this.layers.length-1&&(this.layers.splice(e+1,0,this.layers.splice(e,1)[0]),this.layerItemPanel.insertBefore(this.selectedLayer.element.nextSibling,this.selectedLayer.element))}},r.prototype.createLayer=function(e){var t={object:e,element:Utility.getElementFromTemplate(i,this.layerItemPanel),isVisible:null!=e.isVisible?e.isVisible:!0};t.title=t.element.querySelector("input"),t.title.value=e.name,this.layers.push(t),this.selectedLayer||this.selectLayer(t)},r.prototype.createLayerFromType=function(e,t){var i=new t;i.type=e,this.createLayer(i)},r.prototype.removeLayer=function(e){this.layerItemPanel.removeChild(e.element),Utility.remove(this.layers,e),this.selectedLayer===e&&this.selectLayer(this.layers[0])},r.prototype.selectLayer=function(e){if(this.selectedLayer!==e){for(this.selectedLayer&&(this.selectedLayer.object.isSelected=!1,this.selectedLayer.element.classList.remove("selected"),this.selectedLayer.object.onDeselected&&this.selectedLayer.object.onDeselected()),this.selectedLayer=e;this.propertiesPanel.firstChild;)this.propertiesPanel.removeChild(this.propertiesPanel.firstChild);if(this.selectedLayer){if(this.selectedLayer.object.isSelected=!0,this.selectedLayer.element.classList.add("selected"),this.selectedLayer.object.getPanel){var t=this.selectedLayer.object.getPanel();t&&Utility.appendElements(this.propertiesPanel,t)}this.selectedLayer.object.onSelected&&this.selectedLayer.object.onSelected()}}},r.prototype.updateLayerNames=function(){for(var e=0;e<this.layers.length;e++){var t=this.layers[e];t.object.name=t.title.value}},r.prototype.onToggleGridVisibility=function(e){n(this.grid,e.target)},r.prototype.clear=function(){for(this.layers.length=0,this.selectLayer(null),this.propertiesSection.clear();this.layerItemPanel.firstChild;)this.layerItemPanel.removeChild(this.layerItemPanel.firstChild)},r.prototype.loadData=function(t,i){this.clear();var r=this.element.querySelector('[data-name="saveFileName"]');if(r.value=t.substr(0,t.lastIndexOf(".")),i.properties&&(this.properties=i.properties,this.propertiesSection.setObject(this.properties)),i.layers)for(var n=0;n<i.layers.length;n++){var s=i.layers[n],o=e.Plugins.layerTypes[s.type];if(o){var a=new o;a.name=s.name,a.type=s.type,a.deserialize(s),this.createLayer(a)}}},r.prototype.onClick=function(e){var t=Utility.findParent(e.target,".layer");if(t){var i=Utility.findByProperty(this.layers,"element",t);Utility.matches(e.target,".remove-icon")?this.removeLayer(i):(this.selectLayer(i),Utility.matches(e.target,".visibility-icon")&&n(i,e.target))}e.stopPropagation()},r.prototype.onLoad=function(t){e.FileHandler.loadJSON(t.target.files[0],this.loadData.bind(this))},r.prototype.onSave=function(t){var i=this.element.querySelector('[data-name="saveFileName"]').value||"level",r={layers:[]};Utility.isObjectEmpty(this.properties)||(r.properties=this.properties),this.updateLayerNames();for(var n=0;n<this.layers.length;n++){var s=this.layers[n].object;r.layers.push(Utility.merge({name:s.name,type:s.type},s.serialize()))}e.FileHandler.saveJSON(i+".json",JSON.stringify(r)),t.stopPropagation()},r}),define("editor/core/editorInterface",["Editor","./mainPanel"],function(e,t){"use strict";function i(){e.Scheduler.schedule({context:this,method:this.draw,priority:e.Scheduler.priority.render}),e.Scheduler.schedule({context:this,method:this.update}),e.InputHandler.on("mousedown",this,this.forwardEvent.bind(this,"onMouseDown")),e.InputHandler.on("mousemove",this,this.forwardEvent.bind(this,"onMouseMove")),e.InputHandler.on("mouseup",this,this.forwardEvent.bind(this,"onMouseUp")),e.InputHandler.on("click",this,this.forwardEvent.bind(this,"onClick")),e.InputHandler.on("keydown",this,this.forwardEvent.bind(this,"onKeyDown")),e.InputHandler.on("keyup",this,this.forwardEvent.bind(this,"onKeyUp")),e.InputHandler.on("dragBegin",this,this.forwardEvent.bind(this,"onDragBegin")),e.InputHandler.on("drag",this.onDrag.bind(this)),e.InputHandler.on("dragEnd",this.forwardEvent.bind(this,"onDragEnd")),e.InputHandler.on("pinch",this.onPinch.bind(this)),e.InputHandler.on("mousewheel",this.onMouseWheel.bind(this)),this.mainPanel=new t,this.loadResources()}function r(e){return e.target.tagName&&"canvas"===e.target.tagName.toLowerCase()}return i.prototype.onLoaded=function(e){this.viewport=e},i.prototype.update=function(e,t){this.viewport.update(t)},i.prototype.draw=function(e,t){for(var i=this.mainPanel.layers.length-1;i>=0;i--){var r=this.mainPanel.layers[i];r.isVisible&&r.object.draw&&r.object.draw(this.viewport,t)}var n=this.mainPanel.grid;n.isVisible&&(this.viewport.context.lineWidth=.5,this.viewport.context.strokeStyle="blue",this.viewport.renderer.drawGrid(this.viewport,n.rect,n.tileSize))},i.prototype.forwardEvent=function(e,t){if(this.mainPanel.selectedLayer&&this.mainPanel.selectedLayer.isVisible&&r(t)){var i=this.mainPanel.selectedLayer.object;i[e]&&i[e](t,this.viewport)}},i.prototype.onDrag=function(e,t,i){r(e)&&(1===e.which&&this.forwardEvent("onDragUpdate",e),2===e.which&&this.viewport.move(t,i))},i.prototype.onPinch=function(e,t,i,n){r(e)&&this.viewport.setScale(this.viewport.scale+n,new Vector2(t,i))},i.prototype.onMouseWheel=function(e,t){e.target.tagName&&"canvas"===e.target.tagName.toLowerCase()&&this.viewport.setScale(this.viewport.scale+t,new Vector2(e.pageX,e.pageY))},i.prototype.loadResources=function(){var t=e.Plugins.resources;if(t)for(var i=0;i<t.length;i++){var r=t[i],n=r.fileName,s=n.substr(0,n.lastIndexOf(".")),o=e.ImageCache.loadImage(s,"resources/"+n);o.tileWidth=r.tileWidth,o.tileHeight=r.tileHeight}},i}),define("text!editor/templates/objectLayerPanel.html",[],function(){return'<div class="header">\r\n    <label>Object Layer Properties</label>\r\n    <div class="header-button-panel">\r\n        <div class="icon add-icon" title="Add property"></div>\r\n    </div>\r\n</div>\r\n<div class="contents tile-layer-panel"></div>'}),define("editor/layers/objectLayer",["Editor","text!../templates/objectLayerPanel.html"],function(e,t){"use strict";function i(){this.name="Object Layer",this.objects=[],this.selectedItems=[],this.properties={},this.elements=Utility.getElementFromTemplate(t),this.propertiesSection=new e.PropertiesSection,this.propertiesSection.setObject(this.properties),this.initialize()}return i.prototype.createObject=function(e,t,i){var r=new t;r.initialize&&r.initialize(i.x,i.y),r.rect||(r.rect=new Rectangle(Math.floor(i.x),Math.floor(i.y),r.width||64,r.height||64)),r.typeName=e,this.objects.push(r)},i.prototype.draw=function(e){for(var t=0;t<this.objects.length;t++){var i=this.objects[t];i.draw&&i.draw(e)}for(e.context.strokeStyle="#99d2ff",t=0;t<this.selectedItems.length;t++){var r=this.selectedItems[t];e.renderer.drawRectangle(e,r.rect),e.context.stroke()}},i.prototype.getObjectAt=function(e,t){for(var i=0;i<this.objects.length;i++){var r=this.objects[i];if(e>=r.rect.left&&t>=r.rect.top&&e<=r.rect.right&&t<=r.rect.bottom)return r}},i.prototype.getPanel=function(){return this.elements},i.prototype.initialize=function(){var e=this.elements[1];e.insertBefore(this.propertiesSection.element,e.firstChild),this.elements[0].querySelector(".add-icon").addEventListener("click",this.propertiesSection.addNewProperty.bind(this.propertiesSection),!1)},i.prototype.onDragBegin=function(e,t){var i=t.fromScreen(e.pageX,e.pageY),r=this.getObjectAt(i.x,i.y);r&&(this.selectItems(r),this.draggable={obj:r,offset:Vector2.subtract(r.rect.getPosition(),i)})},i.prototype.onDragUpdate=function(e,t){if(this.draggable){var i=t.fromScreen(e.pageX,e.pageY),r=Vector2.add(i,this.draggable.offset);this.draggable.obj.setPosition(r.x,r.y),this.propertiesSection.update()}},i.prototype.onDragEnd=function(e,t){if(this.draggable){var i=t.fromScreen(e.pageX,e.pageY),r=Vector2.add(i,this.draggable.offset);this.draggable.obj.setPosition(r.x,r.y),this.propertiesSection.update(),this.draggable=null}},i.prototype.onClick=function(t,i){var r=i.fromScreen(t.pageX,t.pageY);if(1===t.which)this.selectItems(this.getObjectAt(r.x,r.y));else if(3===t.which){var n=e.Plugins.objectTypes;if(!n||Utility.isObjectEmpty(n))return;this.popup=new e.Popup(n).show(t.pageX,t.pageY),this.popup.on("close",this,function(){this.popup=null}.bind(this)),this.popup.on("itemClick",this,function(e,t){this.createObject(e,t,r)}.bind(this))}},i.prototype.onKeyDown=function(e){if(46===e.keyCode){for(var t=0;t<this.selectedItems.length;t++)Utility.remove(this.objects,this.selectedItems[t]);this.selectItems()}},i.prototype.selectItems=function(e){if(this.selectedItems.length=0,this.propertiesSection.clear(),e&&(Array.isArray(e)?this.selectedItems.push.apply(this.selectedItems,e):this.selectedItems.push(e)),1===this.selectedItems.length){var t=this.selectedItems[0];this.propertiesSection.setConfig(t.getPropertyConfig&&t.getPropertyConfig()),this.propertiesSection.setObject(t)}else this.selectedItems.length||(this.propertiesSection.setConfig(),this.propertiesSection.setObject(this.properties))},i.prototype.deserialize=function(t){t.properties&&(this.properties=t.properties);for(var i=e.Plugins.objectTypes,r=0;r<t.objects.length;r++){var n=t.objects[r],s=i[n.typeName]||i.object;if(s){var o=new s;n.rect&&(n.rect=Rectangle.fromSimpleRect(n.rect)),o.deserialize?o.deserialize(n):Utility.merge(o,n),this.objects.push(o)}}this.selectItems()},i.prototype.serialize=function(){var e={objects:[]};Utility.isObjectEmpty(this.properties)||(e.properties=this.properties);for(var t=0;t<this.objects.length;t++){var i=this.objects[t],r=Utility.merge({},i.serialize?i.serialize():i);r.rect&&(r.rect=r.rect.getSimpleRect()),e.objects.push(r)}return e},i}),define("engine/media/spriteSheet",["../core/events"],function(e){"use strict";function t(e){this.animations=[],this.currentTile=0,Utility.merge(this,i,e)}var i={tileWidth:64,tileHeight:64};return t.prototype.defineAnimation=function(e,t){t.frames||(t.frames={}),t.name=e,this.animations[e]=t},t.prototype.getCurrentTileBounds=function(){return this.currentTileBounds||(this.currentTileBounds=this.getTileBounds(this.currentTile)),this.currentTileBounds},t.prototype.getTile=function(e,t){return this.image.isLoaded?e+t*Math.floor(this.image.width/this.tileWidth):void 0},t.prototype.getTileByPosition=function(e,t){if(this.image.isLoaded){var i=Math.floor(this.image.width/this.tileWidth),r=Math.floor(e/this.tileWidth),n=Math.floor(t/this.tileWidth);return r+n*i}},t.prototype.getTileBounds=function(e){if(this.image.isLoaded){var t=Math.floor(this.image.width/this.tileWidth),i=e%t*this.tileWidth,r=Math.floor(e/t)*this.tileHeight;return{x:i,y:r,width:this.tileWidth,height:this.tileHeight}}},t.prototype.isLoaded=function(){return this.image&&this.image.isLoaded},t.prototype.playAnimation=function(e){this.currentAnimation=this.animations[e],this.currentAnimation.isComplete=!1,this.setCurrentTile(this.currentAnimation.start),this.animationTime=0},t.prototype.setCurrentTile=function(e){this.currentTile!==e&&(this.currentTile=e,this.currentTileBounds=null)},t.prototype.setImage=function(e){this.image=e},t.prototype.updateAnimation=function(e){if(this.currentAnimation||this.currentAnimation.isComplete){var t=0;this.animationTime+=e;for(var i=this.currentAnimation.start;i<=this.currentAnimation.end;i++)if(t+=null!=this.currentAnimation.frames[i]?this.currentAnimation.frames[i]:this.currentAnimation.speed,this.animationTime<t)return this.setCurrentTile(i),void 0;this.currentAnimation.isLooping?(this.animationTime-=t,this.setCurrentTile(this.currentAnimation.start)):(this.currentAnimation.isComplete=!0,this.trigger("animationComplete",this.currentAnimation))}},e.register(t.prototype),t}),define("editor/controls/tileSelectionPopup",["engine/core/events"],function(e){"use strict";function t(e){this.brush={},this.spriteSheet=e}var i;return t.prototype.close=function(){i=null,document.body.removeChild(this.element),this.trigger("close")},t.prototype.onMouseAction=function(e){if(1===e.which){var t=e.pageX-this.left+this.element.scrollLeft,i=e.pageY-this.top+this.element.scrollTop;switch(e.type){case"mousedown":this.selectionRange={x1:t,y1:i,x2:t,y2:i},this.setSelectionMarker();break;case"mousemove":this.selectionRange.x2=t,this.selectionRange.y2=i,this.setSelectionMarker();break;case"mouseup":this.brush.tiles=[];for(var r=0;r<this.brush.rect.height;r++)for(var n=0;n<this.brush.rect.width;n++){var s=n+this.brush.rect.left,o=r+this.brush.rect.top,a=this.spriteSheet.getTile(s,o)+1;this.brush.tiles.push(a)}this.trigger("selectionFinished",this.brush),this.close()}}e.preventDefault(),e.stopPropagation()},t.prototype.setSelectionMarker=function(){var e=Rectangle.fromPoints(this.selectionRange.x1,this.selectionRange.y1,this.selectionRange.x2,this.selectionRange.y2),t=Math.floor(e.left/this.spriteSheet.tileWidth),i=Math.floor(e.top/this.spriteSheet.tileHeight),r=Math.ceil(e.right/this.spriteSheet.tileWidth)-t,n=Math.ceil(e.bottom/this.spriteSheet.tileHeight)-i;this.brush.rect=new Rectangle(t,i,r,n),this.selectionMarker.style.display="block",this.selectionMarker.style.left=t*this.spriteSheet.tileWidth+1+"px",this.selectionMarker.style.top=i*this.spriteSheet.tileHeight+1+"px",this.selectionMarker.style.width=r*this.spriteSheet.tileWidth-3+"px",this.selectionMarker.style.height=n*this.spriteSheet.tileHeight-3+"px"},t.prototype.show=function(e,t){i&&i.close(),this.element=document.createElement("div"),this.element.className="popup",this.selectionMarker=document.createElement("div"),this.selectionMarker.className="selection-marker",this.element.appendChild(this.spriteSheet.image.data),this.element.appendChild(this.selectionMarker),document.body.appendChild(this.element);var r=this.element.offsetWidth,n=this.element.offsetHeight,s=document.body.clientWidth,o=document.body.clientHeight;this.left=Utility.clamp(e-r/2,0,s-r),this.top=Utility.clamp(t-n/2,0,o-n),this.element.style.top=this.top+"px",this.element.style.left=this.left+"px",this.element.style.maxWidth=s+"px",this.element.style.maxHeight=o+"px";var a=this.onMouseAction.bind(this);return this.element.addEventListener("mousedown",a,!1),this.element.addEventListener("mousemove",a,!1),this.element.addEventListener("mouseup",a,!1),i=this,this},window.addEventListener("mousedown",function(e){i&&!Utility.findParent(e.target,".popup")&&i.close()},!1),e.register(t.prototype),t}),define("text!editor/templates/tileLayerPanel.html",[],function(){return'<div class="header">\r\n    <label>Tile Layer Properties</label>\r\n    <div class="header-button-panel">\r\n        <div class="icon add-icon" title="Add property"></div>\r\n    </div>\r\n</div>\r\n<div class="contents tile-layer-panel">\r\n    <div class="divider"></div>\r\n    <select data-name="spriteSheetSelect">\r\n        <option></option>\r\n    </select>\r\n    <!--<input type="file" data-name="spriteSheetInput"/>-->\r\n</div>'}),define("editor/layers/tileLayer",["Editor","engine/media/spriteSheet","../controls/tileSelectionPopup","text!../templates/tileLayerPanel.html"],function(e,t,i,r){"use strict";function n(){this.name="Tile Layer",this.state=s.None,this.spriteSheet=new t;var i=e.getGridSettings();this.tileMap=new e.TileMap(i.rect.width,i.rect.height,i.tileSize),this.elements=Utility.getElementFromTemplate(r),this.propertiesSection=new e.PropertiesSection,this.propertiesSection.setConfig({tileSize:{isRequired:!0,minValue:1}}),this.properties={rect:new Rectangle(0,0,this.tileMap.width,this.tileMap.height),tileSize:i.tileSize},this.propertiesSection.setObject(this.properties),this.initialize()}var s={None:0,Painting:1,Copying:2};return n.prototype.draw=function(e){var t=this.tileMap.tileSize;if(this.spriteSheet.isLoaded()&&(e.renderer.drawTiles(e,this.tileMap,this.spriteSheet),this.brush&&this.isSelected&&!this.popup&&this.state===s.None)){var i={xOffset:this.brush.rect.left*t,yOffset:this.brush.rect.top*t,width:this.brush.rect.width,height:this.brush.rect.height,tileSize:t,getTile:this.getBrushTile.bind(this.brush)};e.context.globalAlpha=.6,e.renderer.drawTiles(e,i,this.spriteSheet),e.context.globalAlpha=1}if(e.context.strokeStyle="#cdcdcd",e.renderer.drawRectangle(e,new Rectangle(0,0,this.tileMap.width*t,this.tileMap.height*t)),e.context.stroke(),this.brush&&this.isSelected&&!this.popup){var r=this.brush.rect.clone();r.scale(t,!1),e.context.strokeStyle="#d4ca40",e.renderer.drawRectangle(e,r),e.context.stroke()}},n.prototype.getBrushTile=function(e,t){return this.tiles[e+t*this.rect.width]},n.prototype.getTileHeight=function(t){return e.Plugins.isIsometric?t/2:t},n.prototype.getPanel=function(){return this.elements},n.prototype.initialize=function(){var t=e.ImageCache.getAll();t.sort();for(var i=this.elements[1],r=i.querySelector('[data-name="spriteSheetSelect"]'),n=0;n<t.length;n++){var s=document.createElement("option");s.text=t[n].id,r.add(s,null)}r.addEventListener("change",this.onSpriteSheetSelectChanged.bind(this),!1),i.insertBefore(this.propertiesSection.element,i.firstChild),this.propertiesSection.on("propertyChange",this,this.onPropertyChanged),this.elements[0].querySelector(".add-icon").addEventListener("click",this.propertiesSection.addNewProperty.bind(this.propertiesSection),!1)},n.prototype.onPropertyChanged=function(t,i){if("rect"===t.key){if("width"!==i.key&&"height"!==i.key)return;var r,n;"width"===i.key?(r=i.value,n=this.tileMap.height):(r=this.tileMap.width,n=i.value);for(var s=Math.min(this.tileMap.width,r),o=Math.min(this.tileMap.height,n),a=new e.TileMap(r,n,this.tileMap.tileSize),h=0;s>h;h++)for(var l=0;o>l;l++){var c=this.tileMap.getTile(h,l);c&&a.setTile(h,l,c)}this.tileMap=a}else"tileSize"===t.key&&(this.tileMap.tileSize=i.value)},n.prototype.onSpriteSheetSelectChanged=function(e){this.setSpriteSheetImage(e.target.value)},n.prototype.onMouseDown=function(e,t){if(1===e.which)if(e.altKey){this.state=s.Copying;var i=t.fromScreen(e.pageX,e.pageY);this.selectionRange={x1:i.x,y1:i.y,x2:i.x,y2:i.y}}else this.state=s.Painting},n.prototype.onMouseMove=function(e,t){var i=t.fromScreen(e.pageX,e.pageY);this.state===s.Copying?(this.selectionRange.x2=i.x,this.selectionRange.y2=i.y,this.setBrush()):this.brush&&(this.setBrushPosition(i),this.state===s.Painting&&this.setTile())},n.prototype.onMouseUp=function(e,t){1===e.which&&(this.state===s.Copying?(this.setBrush(),this.selectionRange=null):this.state===s.Painting&&this.brush&&(this.setBrushPosition(t.fromScreen(e.pageX,e.pageY)),this.setTile()),this.state=s.None)},n.prototype.onClick=function(e){3===e.which&&this.spriteSheet.isLoaded()&&(this.popup=new i(this.spriteSheet).show(e.pageX,e.pageY),this.popup.on("selectionFinished",this,function(e){this.brush=e}),this.popup.on("close",this,function(){this.popup=null}))},n.prototype.setBrush=function(){var e=Rectangle.fromPoints(this.selectionRange.x1,this.selectionRange.y1,this.selectionRange.x2,this.selectionRange.y2),t=this.tileMap.tileSize,i=Math.floor(e.left/t),r=Math.floor(e.top/t),n=Math.ceil(e.right/t)-i,s=Math.ceil(e.bottom/t)-r;for(this.brush={tiles:[],rect:new Rectangle(i,r,n,s)},r=this.brush.rect.top;r<this.brush.rect.bottom;r++)for(i=this.brush.rect.left;i<this.brush.rect.right;i++){var o=0;this.tileMap.isInBounds(i,r)&&(o=this.tileMap.getTile(i,r)),this.brush.tiles.push(o)}},n.prototype.setBrushPosition=function(e){this.brush.rect.left=Math.floor(.5+e.x/this.tileMap.tileSize-this.brush.rect.width/2),this.brush.rect.top=Math.floor(.5+e.y/this.tileMap.tileSize-this.brush.rect.height/2)},n.prototype.setSpriteSheetImage=function(t){var i=e.ImageCache.getImage(t);this.spriteSheetName=t,this.spriteSheet.setImage(i),this.spriteSheet.tileWidth=i.tileWidth,this.spriteSheet.tileHeight=i.tileHeight},n.prototype.setTile=function(){for(var e=0;e<this.brush.rect.width;e++)for(var t=0;t<this.brush.rect.height;t++){var i=this.brush.rect.left+e,r=this.brush.rect.top+t;if(this.tileMap.isInBounds(i,r)){var n=this.brush.tiles[e+t*this.brush.rect.width];this.tileMap.setTile(i,r,n)}}},n.prototype.deserialize=function(t){this.properties=t.properties,this.properties.rect=Rectangle.fromSimpleRect(this.properties.rect),this.propertiesSection.setObject(this.properties),this.tileMap=new e.TileMap(this.properties.rect.width,this.properties.rect.height,this.properties.tileSize);for(var i=0;i<t.tiles.length;i++)this.tileMap.setTileAtIndex(i,t.tiles[i]);this.elements[1].querySelector('[data-name="spriteSheetSelect"]').value=t.spriteSheet,this.setSpriteSheetImage(t.spriteSheet)},n.prototype.serialize=function(){for(var e=[],t=0;t<this.tileMap.tiles.length;t++)e.push(this.tileMap.tiles[t]);var i=Utility.merge({},this.properties);return i.rect=i.rect.getSimpleRect(),{properties:i,spriteSheet:this.spriteSheetName,tiles:e}},n}),define("Editor",["engine/data/fileHandler","engine/media/imageCache","engine/core/inputHandler","editor/controls/popup","editor/controls/propertiesSection","engine/core/scheduler","engine/spatial/tileMap","engine/data/webStorage"],function(e,t,i,r,n,s,o,a){"use strict";return{FileHandler:e,InputHandler:i,ImageCache:t,Popup:r,PropertiesSection:n,Scheduler:s,TileMap:o,WebStorage:a}}),require(["engine/game/game","engine/rendering/render2dIsometric","engine/rendering/render2d","editor/core/editorInterface","editor/layers/objectLayer","editor/layers/tileLayer"],function(e,t,i,r,n,s){"use strict";e.onReady(function(){require(["Editor","Plugins"],function(o,a){o.Plugins=a,o.Plugins.layerTypes=Utility.merge({objectLayer:n,tileLayer:s},o.Plugins.layerTypes),e.renderer=o.Plugins.isIsometric?t:i,e.setScene(new r)})},i)}),define("editor/main",function(){});